<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Subcategorías</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="/css/subcategoria.css">
</head>

<body>

<header class="header">
  <h1>Subcategorías</h1>
</header>

<!-- ===== TOTAL AVANCE ===== -->
<section class="total-card">
  <div class="total-title">TOTAL DEL AVANCE</div>
  <div class="progress-text" id="total-text">0%</div>
  <div class="progress-container">
    <div class="progress-bar red" id="total-bar"></div>
  </div>
</section>

<main>
  <div id="sub-lista" class="grid"></div>
</main>

<button id="crearSubBtn" class="primary-btn">➕ Crear Subcategoría</button>

<footer class="footer">
  <button id="volverAreas" class="secondary-btn">
    ← Volver a Áreas
  </button>
</footer>

<!-- ===== MODAL ===== -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Nueva Subcategoría</h3>

    <select id="subSelect"></select>

    <div class="spinner" id="spinner"></div>

    <div class="modal-actions">
      <button id="confirmCrear" class="primary-btn">Crear</button>
      <button id="cancelarModal" class="secondary-btn">Cancelar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const params = new URLSearchParams(window.location.search);
  const areaId = params.get('area');
  const proyectoId = params.get('proyecto');

  const lista = document.getElementById('sub-lista');
  const modal = document.getElementById('modal');
  const spinner = document.getElementById('spinner');
  const btnConfirm = document.getElementById('confirmCrear');

  document.getElementById('volverAreas').addEventListener('click', () => {
  window.location.href = `/areas.html?proyecto=${proyectoId}`;
});

  /* ================= CARGAR SUBCATEGORÍAS ================= */
  async function cargarSubcategorias() {

    const res = await fetch(`/api/subcategorias/${areaId}/subcategorias`);
    const data = await res.json();

    lista.innerHTML = '';
    let suma = 0;

    data.forEach(sub => {

      const porcentaje = sub.porcentaje ?? 0;
      suma += porcentaje;

      let color = 'red';
      if (porcentaje >= 70) color = 'green';
      else if (porcentaje >= 40) color = 'yellow';

      const card = document.createElement('div');
      card.className = 'sub-card';

      card.innerHTML = `
        <a class="sub-link"
           href="/evaluacion.html?proyecto=${proyectoId}&area=${areaId}&subcategoria=${sub.subcategoria_id}&nombre=${encodeURIComponent(sub.nombre)}">
           ${sub.nombre}
        </a>

        <div class="progress-text">${porcentaje}% completado</div>
        <div class="progress-container">
          <div class="progress-bar ${color}" style="width:${porcentaje}%"></div>
        </div>

        <button class="btn-delete" data-id="${sub.subcategoria_id}">
          Eliminar
        </button>
      `;

      lista.appendChild(card);
    });

    /* ===== TOTAL ===== */
    const total = data.length ? Math.round(suma / data.length) : 0;
    const totalBar = document.getElementById('total-bar');
    const totalText = document.getElementById('total-text');

    totalText.textContent = `${total}%`;
    totalBar.style.width = `${total}%`;
    totalBar.className = 'progress-bar';

    if (total >= 70) totalBar.classList.add('green');
    else if (total >= 40) totalBar.classList.add('yellow');
    else totalBar.classList.add('red');
  }

  cargarSubcategorias();

  /* ================= ABRIR MODAL ================= */
  document.getElementById('crearSubBtn').addEventListener('click', async () => {

    modal.classList.add('show');
    spinner.style.display = 'block';
    btnConfirm.disabled = true;

    const res = await fetch(
      `/api/subcategorias/${areaId}/subcategorias-disponibles`
    );
    const data = await res.json();

    const select = document.getElementById('subSelect');
    select.innerHTML = '';

    data.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.nombre;
      select.appendChild(opt);
    });

    spinner.style.display = 'none';
    btnConfirm.disabled = false;
  });

  /* ================= CERRAR MODAL ================= */
  document.getElementById('cancelarModal').addEventListener('click', () => {
    modal.classList.remove('show');
  });

  modal.addEventListener('click', e => {
    if (e.target === modal) modal.classList.remove('show');
  });

  /* ================= CREAR ================= */
  btnConfirm.addEventListener('click', async () => {

    btnConfirm.disabled = true;
    spinner.style.display = 'block';

    const nombre_subcategoria_id =
      document.getElementById('subSelect').value;

    await fetch('/api/subcategorias', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        area_conocimiento_id: areaId,
        nombre_subcategoria_id
      })
    });

    spinner.style.display = 'none';
    btnConfirm.disabled = false;
    modal.classList.remove('show');
    cargarSubcategorias();
  });

  let subcategoriaAEliminar = null;

/* ================= ELIMINAR (MODAL) ================= */
lista.addEventListener('click', e => {
  if (!e.target.classList.contains('btn-delete')) return;

  subcategoriaAEliminar = e.target.dataset.id;
  document.getElementById('deleteModal').classList.add('show');
});

/* CONFIRMAR */
document.getElementById('confirmDelete').addEventListener('click', async () => {
  if (!subcategoriaAEliminar) return;

  await fetch(`/api/subcategorias/${subcategoriaAEliminar}`, {
    method: 'DELETE'
  });

  document.getElementById('deleteModal').classList.remove('show');
  subcategoriaAEliminar = null;
  cargarSubcategorias();
});

/* CANCELAR */
document.getElementById('cancelDelete').addEventListener('click', () => {
  document.getElementById('deleteModal').classList.remove('show');
  subcategoriaAEliminar = null;
});

/* CERRAR AL HACER CLICK FUERA */
document.getElementById('deleteModal').addEventListener('click', e => {
  if (e.target.id === 'deleteModal') {
    e.target.classList.remove('show');
    subcategoriaAEliminar = null;
  }
});


});
</script>

<!-- ===== MODAL ELIMINAR ===== -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>¿Eliminar subcategoría?</h3>
    <p>Esta acción no se puede deshacer.</p>

    <div class="modal-actions">
      <button id="confirmDelete" class="primary-btn danger">
        Eliminar
      </button>
      <button id="cancelDelete" class="secondary-btn">
        Cancelar
      </button>
    </div>
  </div>
</div>

</body>
</html>
