<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proyectos</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="/css/estiloproyectos.css">
</head>

<body>

<header class="header">
  <h1>Gestión de Proyectos</h1>
  <button id="crearProyectoBtn" class="primary-btn">➕ Nuevo Proyecto</button>
</header>

<main>
  <div id="proyectos-lista" class="grid"></div>
</main>

<!-- ================= MODAL CREAR ================= -->
<div id="crearModal" class="modal">
  <div class="modal-content">
    <h3>Crear Proyecto</h3>
    <input id="nombreProyecto" type="text" placeholder="Nombre del proyecto">

    <div class="modal-actions">
      <button id="guardarProyectoBtn" class="primary-btn">Guardar</button>
      <button id="cerrarModalBtn" class="secondary-btn">Cancelar</button>
    </div>
  </div>
</div>

<!-- ================= MODAL CONFIRMAR ELIMINACIÓN ================= -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>Eliminar proyecto</h3>

    <p id="textoEliminar">
      ¿Eliminar el proyecto <strong></strong> y TODO su contenido?
    </p>

    <div class="modal-actions">
      <button id="cancelarEliminarBtn" class="secondary-btn">Cancelar</button>
      <button id="confirmarEliminarBtn" class="danger-btn">
        <span class="btn-text">Eliminar</span>
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const lista = document.getElementById('proyectos-lista');

  const crearModal = document.getElementById('crearModal');
  const confirmModal = document.getElementById('confirmModal');

  const textoEliminar = document.querySelector('#textoEliminar strong');
  const btnConfirmarEliminar = document.getElementById('confirmarEliminarBtn');

  let proyectoAEliminar = null;

  /* ================= CARGAR PROYECTOS ================= */
  fetch('/api/proyectos')
    .then(res => res.json())
    .then(proyectos => {

      lista.innerHTML = '';

      proyectos.forEach(p => {
        const card = document.createElement('div');
        card.className = 'project-card';

        card.innerHTML = `
          <h3>${p.nombre}</h3>
          <div class="btn-group">
            <button class="secondary-btn ver-btn" data-id="${p.id}">
              Ver áreas
            </button>
            <button class="danger-btn eliminar-btn" data-id="${p.id}">
              Eliminar
            </button>
          </div>
        `;

        lista.appendChild(card);
      });
    });

  /* ================= EVENTOS DE LISTA ================= */
  lista.addEventListener('click', (e) => {

    if (e.target.classList.contains('ver-btn')) {
      const id = e.target.dataset.id;
      window.location.href = `/areas.html?proyecto=${id}`;
    }

    if (e.target.classList.contains('eliminar-btn')) {

      proyectoAEliminar = e.target.dataset.id;

      const card = e.target.closest('.project-card');
      const nombre = card.querySelector('h3').textContent;

      textoEliminar.textContent = `"${nombre}"`;
      confirmModal.classList.add('show');
    }
  });

  /* ================= CREAR PROYECTO ================= */
  document.getElementById('crearProyectoBtn').addEventListener('click', () => {
    crearModal.classList.add('show');
  });

  document.getElementById('cerrarModalBtn').addEventListener('click', () => {
    crearModal.classList.remove('show');
  });

  document.getElementById('guardarProyectoBtn').addEventListener('click', async () => {

    const nombre = document.getElementById('nombreProyecto').value.trim();
    if (!nombre) return alert('Ingrese un nombre');

    const res = await fetch('/crear-proyecto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nombre })
    });

    if (res.ok) location.reload();
    else alert('Error al crear el proyecto');
  });

  /* ================= CONFIRMAR ELIMINACIÓN ================= */
  document.getElementById('cancelarEliminarBtn').addEventListener('click', () => {
    confirmModal.classList.remove('show');
    proyectoAEliminar = null;
  });

  btnConfirmarEliminar.addEventListener('click', async () => {

    if (!proyectoAEliminar) return;

    const btnText = btnConfirmarEliminar.querySelector('.btn-text');
    btnText.innerHTML = '<span class="loader"></span>';
    btnConfirmarEliminar.disabled = true;

    try {
      const res = await fetch(`/api/proyectos/${proyectoAEliminar}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        location.reload();
      } else {
        throw new Error();
      }

    } catch {
      alert('Error al eliminar el proyecto');
    }
  });

});
</script>

</body>
</html>
