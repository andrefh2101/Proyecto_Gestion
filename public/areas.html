<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Áreas de Conocimiento</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="/css/estiloareas.css">
</head>

<body>

<header class="header">
  <h1>Áreas de Conocimiento</h1>
  <button id="crearAreaBtn" class="primary-btn">➕ Nueva Área</button>
</header>

<main>
  <div id="areas-lista" class="grid"></div>
</main>

<!-- ================= MODAL CREAR ÁREA ================= -->
<div id="areaModal" class="modal">
  <div class="modal-content">
    <h3>Nueva Área</h3>

    <form id="form-area">
      <label>Área de Conocimiento</label>
      <select id="nombreArea" required></select>

      <div class="modal-actions">
        <button type="submit" class="primary-btn">Crear</button>
        <button type="button" id="closeAreaModal" class="secondary-btn">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<footer class="footer">
  <button id="volverProyectos" class="secondary-btn">
    ← Volver a proyectos
  </button>
</footer>


<script>
document.addEventListener('DOMContentLoaded', () => {

  const params = new URLSearchParams(window.location.search);
  const proyectoId = params.get('proyecto');

  const lista = document.getElementById('areas-lista');
  const modal = document.getElementById('areaModal');
  const selectArea = document.getElementById('nombreArea');

  /* ================= CARGAR ÁREAS ================= */
  async function cargarAreas() {

    const res = await fetch(`/api/proyectos/${proyectoId}/areas`);
    const areas = await res.json();

    lista.innerHTML = '';

    if (areas.length === 0) {
      lista.innerHTML = `
        <p class="empty-state">
          No hay áreas registradas aún
        </p>`;
      return;
    }

    areas.forEach(area => {

      const card = document.createElement('div');
      card.className = 'area-card';

      card.innerHTML = `
        <h3>${area.nombre}</h3>
      `;

      card.addEventListener('click', () => {
        window.location.href =
          `/subcategorias.html?area=${area.id}&proyecto=${proyectoId}`;
      });

      lista.appendChild(card);
    });
  }

  cargarAreas();

  /* ================= ABRIR MODAL ================= */
  document.getElementById('crearAreaBtn').addEventListener('click', async () => {

    const res = await fetch(`/api/proyectos/${proyectoId}/areas-disponibles`);
    const disponibles = await res.json();

    selectArea.innerHTML = '';

    if (disponibles.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = 'No hay áreas disponibles';
      opt.disabled = true;
      selectArea.appendChild(opt);
    } else {
      disponibles.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.nombre;
        selectArea.appendChild(opt);
      });
    }

    modal.classList.add('show');
  });

  /* ================= CERRAR MODAL ================= */
  document.getElementById('closeAreaModal').addEventListener('click', () => {
    modal.classList.remove('show');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.classList.remove('show');
  });

  /* ================= CREAR ÁREA ================= */
  document.getElementById('form-area').addEventListener('submit', async (e) => {

    e.preventDefault();

    const tipo_id = selectArea.value;

    const res = await fetch('/api/areas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tipo_id,
        proyecto_id: proyectoId
      })
    });

    if (res.ok) {
      modal.classList.remove('show');
      cargarAreas();
    } else {
      alert('Error al crear el área');
    }
  });

  document.getElementById('volverProyectos')
  .addEventListener('click', () => {
    window.location.href = '/proyectos';
  });


});
</script>

</body>
</html>
